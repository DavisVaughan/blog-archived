<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" prefix="og: http://ogp.me/ns#" xmlns:og="http://ogp.me/ns#"><!--<![endif]-->

    <head>
                <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="author" content="">
  
	
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@https://twitter.com/dvaughan32">
        <meta name="twitter:creator" content="@https://twitter.com/dvaughan32">
        <meta name="twitter:domain" content="/">
	
        <meta property="og:site_name" content="Data Insights">
        <meta property="og:title" content="Data Insights">
        <meta property="og:url" content="/2018/12/25/response-to-optimism/">
        <meta property="og:description" content="">
    
        <meta property="og:type" content="article" />
        <meta property="og:article:author" content="" />
        <meta property="og:article:published_time" content="2018-12-25T00:00:00Z" />
    
        <meta name="generator" content="Hugo 0.49.2" />
        <title>A Response To &#34;Optimism corrected bootstrapping a problematic method&#34; &middot; Data Insights</title>
        <link rel="canonical" href="/" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="">
        <link rel="stylesheet" type="text/css" href="/css/main.css"/>
        <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300|Montserrat:700|Charm|Roboto|Fira+Mono" rel="stylesheet" type="text/css">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
        <link rel="stylesheet" href="/css/monokai-sublime.css">
        <link rel="stylesheet" href="/css/marginnote.css">
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
    </head>

<body>
<!--[if lt IE 7]><p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chrome/‎">install Google Chrome</a> to experience this site.</p><![endif]-->

    <header id="site-header">
        <div class="container">
            <a href="/" alt="Data Insights"><h3>Data Insights</h3></a>
            <p class="blog-description">
              <a href = "/">Home</a>
              |
              <a href = "/about/">About</a>
              |
              <a href = "/resume/davis-vaughan-resume.pdf">Resume</a>
            </p>
        </div>
    </header>
<main class="content" role="main">
	<div class="container">
		<article class="post">
	<header class="post-header">
        <h3 class="p-post-title">A Response To &#34;Optimism corrected bootstrapping a problematic method&#34;</h3>
    </header>

    <section class="post-content">
        <div id="introduction" class="section level3">
<h3>Introduction</h3>
<p><img src="https://img.shields.io/badge/post--status-maturing-blue.svg" /></p>
<p>This is a quick rough draft of a response to <a href="https://intobioinformatics.wordpress.com/2018/12/25/optimism-corrected-bootstrapping-a-problematic-method/">this</a> blog post, which I believe resulted in a faulty conclusion regarding the <em>optimism corrected bootstrap</em> procedure.</p>
<p>I believe their error stems mainly from the use of a <em>training</em> data ROC AUC score, rather than <em>test</em> data ROC AUC score. This comes from using <code>train()$results</code> rather than <code>train()$resample</code>.</p>
<p>Over the next few days, I will continue to refine this post, but I wanted to put this rough version up quickly to dispel any ideas that it was caret or the optimism corrected bootstrap that was the issue.</p>
</div>
<div id="old-code" class="section level3">
<h3>Old code</h3>
<p>This code comes straight from the blog post, except I’ve turned off the verbose output.</p>
<p>Notice that <code>max(fit3$results$ROC)</code> is used. This is the main problem.</p>
<pre class="r"><code>library(caret)
allresults &lt;- matrix(ncol=2,nrow=200)
i = 0
for (z in seq(10,2000,10)){
  
  i = i + 1
  
  # select only two species
  iris &lt;- subset(iris, iris$Species == &#39;versicolor&#39; | iris$Species == &#39;virginica&#39;)
  iris$Species &lt;- droplevels(iris$Species)
  # generate random data
  test &lt;- matrix(rnorm(100*z, mean = 0, sd = 1),
                 nrow = 100, ncol = z, byrow = TRUE)
  # bind random data
  iris &lt;- cbind(iris,test)
  # remove real data
  iris &lt;- iris[,-1:-4]
  
  # cross validation
  ctrl &lt;- trainControl(method = &#39;cv&#39;,
                       summaryFunction=twoClassSummary,
                       classProbs=T,
                       savePredictions = T,
                       verboseIter = F)
  fit3 &lt;- train(as.formula( paste( &#39;Species&#39;, &#39;~&#39;, &#39;.&#39; ) ), data=iris,
                method=&quot;glmnet&quot;, # preProc=c(&quot;center&quot;, &quot;scale&quot;)
                trControl=ctrl, metric = &quot;ROC&quot;) #
  allresults[i,1] &lt;- max(fit3$results$ROC)
  
  # optimism corrected bootstrapping
  ctrl &lt;- trainControl(method = &#39;optimism_boot&#39;,
                       summaryFunction=twoClassSummary,
                       classProbs=T,
                       savePredictions = T,
                       verboseIter = F)
  fit4 &lt;- train(as.formula( paste( &#39;Species&#39;, &#39;~&#39;, &#39;.&#39; ) ), data=iris,
                method=&quot;glmnet&quot;, # preProc=c(&quot;center&quot;, &quot;scale&quot;)
                trControl=ctrl, metric = &quot;ROC&quot;) #
  allresults[i,2] &lt;- max(fit4$results$ROC)
  
  rm(iris)
}

df &lt;- data.frame(allresults)
colnames(df) &lt;- c(&#39;cross_validation&#39;,&#39;optimism_corrected_boot&#39;)
df2 &lt;- reshape2::melt(df)
df2$N &lt;- c(seq(10,2000,10),seq(10,2000,10))

# do the plot
# p1 &lt;- ggplot(df2, aes(x=N, y=value, group=variable)) +
#   geom_line(aes(colour=variable))
# png(&#39;bias_in_optimism_corrected_bootstrapping.png&#39;, height = 15, width = 27, units = &#39;cm&#39;,
#     res = 900, type = &#39;cairo&#39;)
# print(p1)
# dev.off()

ggplot(df2, aes(x=N, y=value, group=variable)) +
  geom_line(aes(colour=variable))</code></pre>
<p><img src="/post/2018-12-25-response-to-optimism/index_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>The above plot shows the number of predictor columns on the x-axis, and the ROC AUC value on the y-axis. The issue here is that it looks like the ROC AUC of the optimism bootstrap method increases as a function of the number of predictors, when it should really be flat at <code>0.5</code>.</p>
</div>
<div id="new-code" class="section level3">
<h3>New code</h3>
<p>This is a bit closer to what I would have done. Rewriting it helped me get to the bottom of the problem!</p>
<p>Here I use <code>mean(model_fit$resample$ROC)</code> to get the average of the resampled ROC AUC scores.</p>
<pre class="r"><code>library(caret)
library(rlang)
library(purrr)
library(tibble)
library(tidyr)
library(ggplot2)

set.seed(123)

n_predictor_sets &lt;- 200

min_n_predictors &lt;- 10
max_n_predictors &lt;- n_predictor_sets * 10
step &lt;- 10

n_predictors_seq &lt;- seq(from = min_n_predictors, to = max_n_predictors, by = step)

# select only two species and rip out Species as the outcome
iris &lt;- subset(iris, iris$Species == &#39;versicolor&#39; | iris$Species == &#39;virginica&#39;)
outcome_df &lt;- data.frame(outcome = droplevels(iris$Species))

n_obs &lt;- nrow(outcome_df)

# generate random data
generate_predictors &lt;- function(n_predictors, n_obs) {
  
  n_random_points &lt;- n_obs * n_predictors
  
  predictors &lt;- matrix(
    data  = rnorm(n_random_points),
    nrow  = n_obs,
    ncol  = n_predictors,
  )
  
  predictors
}

all_predictors &lt;- map(n_predictors_seq, generate_predictors, n_obs = n_obs)
all_data_sets &lt;- map(all_predictors, cbind, outcome_df)

ctrl_cv &lt;- trainControl(
  method          = &#39;cv&#39;,
  summaryFunction = twoClassSummary,
  classProbs      = TRUE,
  savePredictions = TRUE,
  verboseIter     = FALSE
)

ctrl_opt_boot &lt;- trainControl(
  method          = &#39;optimism_boot&#39;,
  summaryFunction = twoClassSummary,
  classProbs      = TRUE,
  savePredictions = TRUE,
  verboseIter     = FALSE
)

model_formula &lt;- outcome ~ .

fit_glmnet &lt;- function(data_set, ctrl, formula) {
  model_fit &lt;- train(
    form = formula, 
    data = data_set, 
    method = &quot;glmnet&quot;, 
    trControl = ctrl, 
    metric = &quot;ROC&quot;
  )

  mean(model_fit$resample$ROC)
}</code></pre>
<p>I use <code>furrr</code> to fit things in parallel so I’m not here all day.</p>
<pre class="r"><code>library(furrr)

plan(multiprocess)

roc_cv &lt;- future_map_dbl(
  all_data_sets, fit_glmnet, 
  ctrl = ctrl_cv, formula = model_formula
)

roc_opt_boot &lt;- future_map_dbl(
  all_data_sets, fit_glmnet, 
  ctrl = ctrl_opt_boot, formula = model_formula
)</code></pre>
<pre class="r"><code>all_results &lt;- tibble(
  cross_validation = roc_cv,
  optimism_corrected_boot = roc_opt_boot,
  n_predictors = n_predictors_seq
)

all_results &lt;- gather(all_results, &quot;method&quot;, &quot;value&quot;, -n_predictors)</code></pre>
<p>As you can see below, the ROC AUC scores computed while varying the number of predictors is actually more stable when using the optimism bootstrap, and the average is around the same value as the cross validation method.</p>
<pre class="r"><code>ggplot(all_results, aes(x = n_predictors, y = value, group = method)) +
  geom_line(aes(colour = method)) +
  labs(x = &quot;Number of predictors&quot;, y = &quot;ROC AUC&quot;)</code></pre>
<p><img src="/post/2018-12-25-response-to-optimism/index_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code>library(dplyr)

all_results %&gt;%
  group_by(method) %&gt;%
  summarise(
    avg_roc_auc = mean(value),
    sd_roc_auc = sd(value)
  )</code></pre>
<pre><code>## # A tibble: 2 x 3
##   method                  avg_roc_auc sd_roc_auc
##   &lt;chr&gt;                         &lt;dbl&gt;      &lt;dbl&gt;
## 1 cross_validation              0.557     0.0929
## 2 optimism_corrected_boot       0.496     0.0650</code></pre>
</div>

    </section>

    <hr>

    <footer class="post-footer">
        <section class="f-1">
            <section class="share">
                <span>Share:
                <a class="icon-twitter" href="http://twitter.com/share?text=A%20Response%20To%20%22Optimism%20corrected%20bootstrapping%20a%20problematic%20method%22&url=%2f2018%2f12%2f25%2fresponse-to-optimism%2f"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=%2f2018%2f12%2f25%2fresponse-to-optimism%2f"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=%2f2018%2f12%2f25%2fresponse-to-optimism%2f"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="fa fa-google-plus"></i>
                </a>
                </span>
            </section>

            
        </section>
                
        <section id="comments">
            <div id="disqus_thread" class="post-comments"></div>
            <script type="text/javascript">
              if (window.location.hostname != "localhost") {
                var disqus_shortname = 'datainsights';
                (function() {
                  var dsq = document.createElement('script');
                  dsq.type = 'text/javascript';
                  dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              }
            </script>
            <noscript>
              Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
            </noscript>
        </section>
                
    </footer>
</article>
	</div>
</main>
    <footer id="site-footer">
        <div class="container">
          
          
            <a href="https://www.twitter.com/dvaughan32" title="Twitter" target="_blank"><span class="tooltip"><i class="fa fa-twitter"></i></span></a>
          
          
            <a href="https://www.github.com/DavisVaughan" title="GitHub" target="_blank"><span class="tooltip"><i class="fa fa-github"></i></span></a>
          
          <a href="/index.xml" title="Get the RSS feed"><span class="tooltip"><i class="fa fa-rss"></i></span></a>
          <section>&copy; <a href="/"></a> 2017 | All rights reserved</section>
          <section>Theme by <a href="http://www.jrdnbwmn.com">Jordan Bowman</a>. Generated with <a href="http://gohugo.io/">Hugo</a>.</section>
        </div>
    </footer>

    <script type="text/javascript" src="/js/fittext.js"></script>
    <script type="text/javascript">
      $(".heading").fitText();
    </script>
    
    <script src="/js/math-code.js"></script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    });
    </script>
    <script type="text/javascript"
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>


    <script>
        var _gaq=[['_setAccount','UA-99003915-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src='//www.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>


</body>
</html>